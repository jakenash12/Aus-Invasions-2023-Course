---
title: "ITS_DataImport_AlphaBetaDiv"
author: "Jake Nash"
date: "2024-04-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Required Packages
```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(vegan)
library(magrittr)
library(tibble)
library(FUNGuildR)
```

## Import taxonomy file and parse taxonomy string into separate columns
```{r, warning=FALSE, message=FALSE}
extract_text <- function(x) {
  sub(".+__", "", x)
}

TaxMatITS=
  read_tsv("../Aus23_ITS_Metabarcoding/ITS2_Dada2_repseqs97_taxonomy.tsv") %>%
  rename("otu"="Feature ID") %>%
  select(-Confidence) %>%
  separate_wider_delim(too_few="align_start", cols = Taxon, delim = ";", names = c("Kingdom", "Phylum","Class", "Order","Family","Genus","Species", "SH")) %>%
  mutate(across(!contains("otu"), ~extract_text(.)))
```

## Import ASV table
```{r, warning=FALSE, message=FALSE}
OtuMatITS=
  read_tsv("../Aus23_ITS_Metabarcoding/ITS2_OTUTable_97.tsv", skip=1) %>%
  column_to_rownames("#OTU ID")
```

## Import Metadata
```{r, warning=FALSE, message=FALSE}
Metadata_ITS=
  read_tsv("../Aus23_16S_Metabarcoding/MetabarcodingMetadata.txt") %>%
  slice(-1) %>% #remove the comment row 
  rename("SampleID"=`sample-id`) #rename SampleID column
```

## Calculates sequencing depth per sample, then rarefies to 70218
Rarefaction curves are generated showing rarefaction point as dotted line. Rarefaction resulted in dropping sample P3-2_Root and the negative control. OTUs that had 0 sequences remaining after rarefaction were removed. Random seed was set to ensure reproducibility
```{r}
#calculates sequencing depth by taking column sums of OTU table
SeqDepthITS=
  OtuMatITS %>%
  colSums() %>%
  as.data.frame %>%
  set_colnames("n_sequences")

#uses vegan function to generate rarefaction curve dataframe using a step of 500 seqs
RareCurve_ITs=
  OtuMatITS %>%
  t %>%
  rarecurve(step=500, tidy=TRUE)

#sets rarefaction depth to 70,218 seqs, based on seq depth dataframe
rare_depth_ITS=70218
#plots rarefaction curve, drawing a vertical line at the rarefaction depth
ggplot(RareCurve_ITs, aes(x=Sample, y=Species, group=Site)) +
  geom_line() +
  geom_vline(xintercept=rare_depth_ITS, linetype=2) +
  ylab("# ASVs") +
  xlab("# Sequences")

set.seed(2023) #make sure to set the random seed so that rarefaction is reproducible

#uses vegan rarefaction function to rarefy to previously defined rarefaction depth
OtuMatITS_rare=
  OtuMatITS %>%
  t %>%
  as.data.frame %>%
  rrarefy(sample=rare_depth_ITS) %>%
  as.data.frame %>%
  select(-which(colSums(.) == 0)) %>%
  filter(rowSums(.) >= 70218)

```

## Generates an OTU table where replicates from the same tree are pooled
This is done by taking the rarefied OTU table, then summing together the sequence counts for both replicates from each tree. For the soil samples, this means summing together the north and south plots, and for the root samples this means summing together the 2 PCR technical replicates
```{r, warning=FALSE, message=FALSE}
OtuMatITS_rare_pooled=
  OtuMatITS_rare %>%
  mutate(TreeSampleType = gsub("-.", "", rownames(.))) %>% #make a new column with the tree ID and sample type
  group_by(TreeSampleType) %>% #group dataframe by tree ID and sample type
  summarise(across(everything(), sum, .names = "{.col}")) %>% #sum together sequence counts for all samples that were from the same tree and sample type
  column_to_rownames("TreeSampleType") #set rownames to tree ID_sample type

```

## Generates relative abundance OTU table versions of the unpooled and pooled rarefied tables
This is done by dividing each OTU's sequence count by the total sequence count for that sample. This makes it so that all rows sum to 1

```{r, warning=FALSE, message=FALSE}
OtuMatITS_rare_pooled_rel=
  OtuMatITS_rare_pooled %>%
  mutate(across(everything(), ~ . / rowSums(across(everything()))))

OtuMatITS_rare_rel=
  OtuMatITS_rare %>%
  mutate(across(everything(), ~ . / rowSums(across(everything()))))
```

## Generates Aitchison distance matrices
This is done on both the pooled and unpooled versions of the OTU table, both after rarefaction (but not on the relativized versions of the OTU tables).

A pseudocount value of 1 is used for the log transform
```{r, warning=FALSE, message=FALSE}
Aitchison_unpooled_ITS=vegdist(OtuMatITS_rare, method = "aitchison", pseudocount=1)

Aitchison_pooled_ITS=vegdist(OtuMatITS_rare_pooled, method = "aitchison", pseudocount=1)
```

## Generates alpha diversity dataframe
```{r, warning=FALSE, message=FALSE}
AlphaDiv_ITS=
  data.frame(Shannon=diversity(OtuMatITS_rare, index="shannon"),
             Simpson=diversity(OtuMatITS_rare, index="simpson"),
             Invsimpson=diversity(OtuMatITS_rare, index="invsimpson"),
             Richness=specnumber(OtuMatITS_rare)) %>%
  mutate(SampleID=rownames(.)) %>%
  left_join(Metadata_ITS)

```

## Generates guild summaries based on fungal traits guild assignments
Need to finish this...
Will merge this with the alpha diversity dataframe and export it as a summary table
```{r, warning=FALSE, message=FALSE}


```

## Saving/exporting files as csv's
OTU tables and distance matrices are saved as csv's so that they can easily be used in other analyses. 
```{r, warning=FALSE, message=FALSE}
filepath="../Aus23_R_outputs/ITS/"

write.csv(OtuMatITS_rare, paste(filepath, "OtuMatITS_rare.csv", sep=""))
write.csv(OtuMatITS_rare_rel, paste(filepath, "OtuMatITS_rare_rel.csv", sep=""))
write.csv(OtuMatITS_rare_pooled, paste(filepath, "OtuMatITS_rare_pooled.csv", sep=""))
write.csv(OtuMatITS_rare_pooled_rel, paste(filepath, "OtuMatITS_rare_pooled_rel.csv", sep=""))

write.csv(as.matrix(Aitchison_unpooled_ITS), paste(filepath, "Aitchison_unpooled_ITS.csv", sep=""))
write.csv(as.matrix(Aitchison_pooled_ITS), paste(filepath, "Aitchison_pooled_ITS.csv", sep=""))
```
