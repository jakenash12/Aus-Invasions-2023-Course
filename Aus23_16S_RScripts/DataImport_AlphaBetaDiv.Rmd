---
title: "DataImport_AlphaBetaDiv"
author: "Jake Nash"
date: "2024-02-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Required Packages
```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(vegan)
library(car)
library(magrittr)
library(ecodist)
```

## Import taxonomy file and parse taxonomy string into separate columns
```{r, warning=FALSE, message=FALSE}
extract_text <- function(x) {
  sub(".+__", "", x)
}

TaxMat16S=
  read_tsv("../Aus23_16S_Metabarcoding/Aus23_16S_SilvaTaxonomy_16S.tsv") %>%
  rename("otu"="Feature ID") %>%
  select(-Confidence) %>%
  separate_wider_delim(too_few="align_start", cols = Taxon, delim = ";", names = c("Kingdom", "Phylum","Class", "Order","Family","Genus","Species")) %>%
  mutate(across(!contains("otu"), ~extract_text(.)))
```

## Import ASV table
```{r, warning=FALSE, message=FALSE}
OtuMat16S=
  read_tsv("../Aus23_16S_Metabarcoding/Aus23_16S_ASV_table.tsv", skip=1) %>%
  column_to_rownames("#OTU ID")
```

## Import Metadata
```{r, warning=FALSE, message=FALSE}
Metadata_16S=
  read_tsv("../Aus23_16S_Metabarcoding/MetabarcodingMetadata.txt") %>%
  slice(-1) %>%
  rename("SampleID"=`sample-id`)
```

## Removes mitochondrial and chloroplast sequences, calculates sequencing depth per sample, then rarefies to 24860
Rarefaction curves are generated showing rarefaction point as dotted line. Rarefaction resulted in dropping sample P3-2_Root and the negative control. OTUs that had 0 sequences remaining after rarefaction were removed. Random seed was set to ensure reproducibility
```{r}
OTUs_remove=
  TaxMat16S %>%
  filter((Genus=="Chloroplast" | Genus=="Mitochondria")) %$%
  otu

OtuMat16S_filtered=
  OtuMat16S %>% 
  filter(!(rownames(.) %in% OTUs_remove))

SeqDepth16S=
  OtuMat16S_filtered %>%
  colSums() %>%
  as.data.frame %>%
  set_colnames("n_sequences")

RareCurve_16s=
  OtuMat16S_filtered %>%
  t %>%
  rarecurve(step=500, tidy=TRUE)

ggplot(RareCurve_16s, aes(x=Sample, y=Species, group=Site)) +
  geom_line() +
  geom_vline(xintercept=24860, linetype=2) +
  ylab("# ASVs") +
  xlab("# Sequences")

set.seed(2023)
OtuMat16S_filtered_rare=
  OtuMat16S_filtered %>%
  t %>%
  as.data.frame %>%
  rrarefy(sample=24860) %>%
  as.data.frame %>%
  select(-which(colSums(.) == 0)) %>%
  filter(rowSums(.) >= 24860)
```

## Conducts PCoA with Aitchison distance
PCoA is first plotted with points colored by sample type. Then PCoA is plotted colored by tree species, this time using axes 2 and 3 because axis 3 shows separation by tree species best.
```{r, warning=FALSE, message=FALSE}
DistMat16s=vegdist(OtuMat16S_filtered_rare, method = "aitchison", pseudocount=1)
PCoA_16S_aitchison_pcoa <- ecodist::pco(DistMat16s)
PCoA_16S_aitchison_pcoa_df=
  PCoA_16S_aitchison_pcoa$vectors %>%
  as.data.frame %>%
  cbind(data.frame(SampleID=rownames(.)), .) %>%
  left_join(Metadata_16S)

ggplot(PCoA_16S_aitchison_pcoa_df, aes(x=X1, y=X2)) +
  geom_point(aes(color=SampleType))

PCoA_16S_aitchison_pcoa_df %>%
  filter(SampleType=="Root") %>%
  ggplot(aes(x=X3, y=X2)) +
  geom_point(aes(color=TreeSpecies))
```

## Conducts PERMANOVA with SampleType*TreeSpecies
```{r, warning=FALSE, message=FALSE}
PERMANOVA_SampleType=adonis(DistMat16s~SampleType*TreeSpecies, data=PCoA_16S_aitchison_pcoa_df)
PERMANOVA_SampleType$aov.tab
```

## Generates alpha diversity dataframe, plots, then ANOVA
```{r, warning=FALSE, message=FALSE}
AlphaDiv_16S=
  data.frame(Shannon=diversity(OtuMat16S_filtered_rare, index="shannon"),
             Simpson=diversity(OtuMat16S_filtered_rare, index="simpson"),
             Invsimpson=diversity(OtuMat16S_filtered_rare, index="invsimpson"),
             Richness=specnumber(OtuMat16S_filtered_rare)) %>%
  mutate(SampleID=rownames(.)) %>%
  left_join(Metadata_16S)

ggplot(AlphaDiv_16S, aes(x=SampleType, y=Richness, color=TreeSpecies)) +
  geom_boxplot()

ggplot(AlphaDiv_16S, aes(x=SampleType, y=Shannon, color=TreeSpecies)) +
  geom_boxplot()

AlphaDiv_16S %>%
  lm(Richness~SampleType*TreeSpecies,.) %>%
  Anova

AlphaDiv_16S %>%
  lm(Shannon~SampleType*TreeSpecies,.) %>%
  Anova
```